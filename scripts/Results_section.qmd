---
---
title: "Results Section"
subtitle: 'Range Changes Montserrat studied by employing occupancy modelling'
author: "Filibert Heim"
format: 
  html: default
  docx: default
editor: visual
date: 10-25-2024
execute: 
   echo: false # excludes code chunks from being displayed in the output
---

## Results

```{r setup, include=FALSE}
#| label: Set global options for rounding and scientific notation
options(digits = 5,        # Round output to 4 significant digits
        scipen = 999)      # Disable scientific notation
```

```{r, message=FALSE, warning=F}
#| label: load data for later plotting

#load packages 
library(tidyverse)
select <- dplyr::select
rename <- dplyr::rename
filter <- dplyr::filter
library(stringr)
library(unmarked)
library(quarto)
library(gt)
library(rlang)

SPECIES <- c("MTOR","FOTH","BRQD","TREM","ACHU","PTCA","PETH","GTCA","SBTH","SNPI", "CAEL","BANA")
species_names <- c("Montserrat Oriole","Forest Thrush","Bridled Quail-Dove","Brown Trembler","Antillean Crested Hummingbird","Purple-Throated Carib","Pearly-Eyed Thrasher","Green-Throated Carib","Scaly-Breasted Thrasher","Scaly-Naped Pigeon", "Caribbean Eleania","Banaquit")
load(file = 'C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/data/MONTSERRAT_ANNUAL_DATA_INPUT2024.RData')

# load in data 
gof_df <- read.csv('C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/data/GOF/GOF_pb_table.csv')
occu <- data.frame()
for(i in 1:length(SPECIES)){
  data <- read.csv(sprintf('C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/data/occupancy_data_ranef/%s_occupancy_data.csv', SPECIES[i])) %>% mutate(species = SPECIES[i])
  occu <- rbind(occu, data)}
occu <- occu %>%
  left_join(species %>% select(SpeciesCode, Species), by = join_by(species == SpeciesCode)) %>% mutate(species_names = str_to_title(Species)) %>% select(-Species)
pred_colext <- data.frame()
birds <- str_remove(list.files(path = 'C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/data/pred_col_ext/'), pattern = '_pred_colext.csv')
for(i in 1:length(birds)){
  data <- read.csv(sprintf('C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/data/pred_col_ext/%s_pred_colext.csv', birds[i])) 
  pred_colext <- rbind(pred_colext, data)}
pred_colext <- pred_colext %>% rename(species = Species) %>%
  left_join(species %>% select(SpeciesCode, Species), by = join_by(species == SpeciesCode)) %>% mutate(species_names = str_to_title(Species)) %>% select(-Species)
modsel <- data.frame()
for(i in 1:length(SPECIES)){
  data <- read.csv(sprintf('C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/data/model_selection/%s_modSel.csv', SPECIES[i])) 
  modsel <- rbind(modsel, data)}
modsel <- modsel %>%
  left_join(species %>% select(SpeciesCode, Species), by = join_by(species == SpeciesCode)) %>% mutate(species_names = str_to_title(Species)) %>% select(-Species)
modsel <- modsel %>% mutate(formula = str_replace_all(formula, pattern = 'alt', replacement = 'elevation'), model = str_replace_all(model, pattern = '_', replacement = '-')) # replace alt by elevation for consistency between tables and text in manuscript
modsel_best <- modsel %>% group_by(species) %>% filter(step == 'g_e') %>% slice_min(AICc) %>% ungroup() # safe details of best models 
coeff_bm <- data.frame()
for(i in 1:length(SPECIES)){
  data <- read.csv(sprintf('C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/data/coefficients_best_model/%s_best_model_coefficients.csv', SPECIES[i])) 
  coeff_bm <- rbind(coeff_bm, data)}
models <- list()
for(i in 1:length(SPECIES)){
  models[[i]] <- readRDS(file = sprintf('C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/data/best_model/%s_best_model.rds', SPECIES[i]))
  names(models)[i] <- SPECIES[i]} 
gof_list <- list()
for(i in 1:length(SPECIES)){
  gof_list[i] <- readRDS(file = sprintf('C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/data/GOF/%s_gof_pb.rds', SPECIES[i]))
  names(gof_list)[i] <- SPECIES[i]}
```

### Overview and Uncertainty

Presence-absence point count data on `r length(SPECIES)` forest bird species on Montserrat were sampled over `r unique(occu$Year) %>% length()` years between `r min(occu$Year)` and `r max(occu$Year)` including `r countdata %>% filter(VisitID != 'NA') %>% filter(!Point %in% c(99,76)) %>% nrow() * length(SPECIES)` observations from `r countdata %>% filter(VisitID != 'NA') %>% filter(!Point %in% c(99,76)) %>% nrow()` surveys.

We found evidence for elevational range changes in `r length(unique(pred_colext$species))` out of the `r length(SPECIES)` analysed species (Figure 1, Table 1), with `r modsel_best %>% filter(model == 'contraction') %>% nrow()` species (Bridled Quail-Dove, Scaly-Breasted Thrasher and Brown Trembler) best explained by the ‘contraction’ model where only extinction depended on elevation, `r modsel_best %>% filter(model == 'expansion') %>% nrow()` species (Purple-Throated Carib) where colonisation was explained by elevation ('expansion' model), and `r modsel_best %>% filter(model == 'shift') %>% nrow()` species (Montserrat Oriole) where both colonisation and extinction were explained by elevation ('shift' model). For another `r modsel_best %>% filter(model == 'constant') %>% nrow()` species (Banaquit, Forest Thrush, Pearly-Eyed Thrasher and Scaly-Naped Pigeon) the most parsimonious model was the ‘constant’ model where both colonisation and extinction were modeled with intercepts only, and for `r modsel_best %>% filter(model == 'year-num') %>% nrow()` species (Antillean Crested Hummingbird, Caribbean Eleania and Green-Throated Carib) both extinction and colonisation were best explained by an annual trend ('year-num' model). An appropriate model fit and thus the validity of the models for inference was not questioned by the performed Chi-Squared goodness of fit test (n = 1000 simulations) since all estimted p-values were above the arbitrary threshold of 0.05 indicating no difference between the observed and survey data. Neverthesles, model selection uncertainty occurred in `r modsel %>% filter(step == 'g_e') %>% filter(Delta_AICc <=2) %>% filter(Delta_AICc !=0) %>% group_by(species) %>% count() %>% nrow()` species including `r intersect(modsel_best %>% filter(model %in% c('shift', 'contraction', 'expansion', 'year_num_shift', 'year_num_contraction', 'year_num_expansion', 'year_fact_shift', 'year_fact_expansion', 'year_fact_contraction')) %>% pull(species), modsel %>% filter(step == 'g_e') %>% filter(Delta_AICc <2) %>% filter(Delta_AICc !=0) %>% group_by(species) %>% count() %>% select(species) %>% pull(species)) %>% length()` (Bridled-Quail Dove and Purple-Throated Carib) which exhibited elevational range changes. However, for these `r intersect(modsel_best %>% filter(model %in% c('shift', 'contraction', 'expansion', 'year-num-shift', 'year-num-contraction', 'year-num-expansion', 'year-fact-shift', 'year-fact-expansion', 'year-fact-contraction')) %>% pull(species), modsel %>% filter(step == 'g_e') %>% filter(Delta_AICc <2) %>% filter(Delta_AICc !=0) %>% group_by(species) %>% count() %>% select(species) %>% pull(species)) %>% length()` species it was not clear whether the elevational changes affected only colonisation, extinction, or both (cumulative wAICc for all elevation model \> 0.7, Table S2), whereas models without elevation received less support (Table S2). In `r intersect(modsel_best %>% filter(!model %in% c('shift', 'contraction', 'expansion', 'year-num-shift', 'year-num-contraction', 'year-num-expansion', 'year-fact-shift', 'year-fact-expansion', 'year-fact-contraction')) %>% pull(species), modsel %>% filter(step == 'g_e') %>% filter(Delta_AICc <2) %>% filter(Delta_AICc !=0) %>% filter(model %in% c('shift', 'contraction', 'expansion', 'year-num-shift', 'year-num-contraction', 'year-num-expansion', 'year-fact-shift', 'year-fact-expansion', 'year-fact-contraction')) %>% pull(species)) %>% length()` other species (Forest Thrush and Scaly-Naped Pigeon), elevation was contained in a competitive, but not the most parsimonious model (Table S2).

```{r, echo=F, warning=F}
#| label: overview table with all effect sizes and gof results

# produce summary table by taking the needed values from all different tables
sum_table <- modsel_best %>% mutate(p_value_Chisq = round(p_value_Chisq, digits = 2), AICcWt = round(AICcWt, digits = 2)) %>%
  select(species, model, formula, p_value_Chisq, AICcWt) %>% 
  left_join(y = gof_df %>% select(species, c_hat)) # add c_hat value from gof_df
sum_table <- sum_table %>% 
  left_join(y = coeff_bm %>% filter(component == 	'psi(Int)') %>% select(-SE, -component)) %>% # add estimate of inital occupancy (CI)
  mutate(psi = paste0(round(plogis(estimate), digits = 2), ' (', round(plogis(lower), digits = 2), ', ', round(plogis(upper), digits = 2), ')')) %>%
  select(-estimate, -upper, -lower)
sum_table <- sum_table %>% # add effect of alt on psi (CI)
  left_join(y = coeff_bm %>% filter(component %in% c('psi(alt)', 'psi(alt:treeheight)')) %>% select(-SE, -component)) %>% 
  mutate(alt_psi = paste0(round(estimate, digits = 2), ' (', round(lower, digits = 2), ', ', round(upper, digits = 2), ')')) %>%
  select(-estimate, -upper, -lower)
sum_table <- sum_table %>% # add effect of alt on col (CI)
  left_join(y = coeff_bm %>% filter(component == 'col(alt)') %>% select(-SE, -component)) %>% 
  mutate(alt_col = paste0(round(estimate, digits = 2), ' (', round(lower, digits = 2), ', ', round(upper, digits = 2), ')')) %>%
  select(-estimate, -upper, -lower)
sum_table <- sum_table %>% # add effect of alt on ext (CI)
  left_join(y = coeff_bm %>% filter(component == 'ext(alt)') %>% select(-SE, -component)) %>% 
  mutate(alt_ext = paste0(round(estimate, digits = 2), ' (', round(lower, digits = 2), ', ', round(upper, digits = 2), ')')) %>%
  select(-estimate, -upper, -lower)

# make table ready to display it in gt - this is sum table 1 which is slightly different than sum table 2
sum_table_1 <- sum_table %>% mutate(across(everything(), ~ str_replace(., "^NA.*", "")), formula = str_replace_all(formula, ' ', ''), c_hat = ifelse(c_hat == '0', '<0.001', c_hat)) %>% # replace all NA's and delete spaces in formula
  select(species, model, formula, psi, alt_psi, alt_col, alt_ext, c_hat, p_value_Chisq, AICcWt) %>% # display columns in the correct order
  rename(Species = species, Model = model, `Formula (~Ψ~γ~ε~P)` = formula, `Initial Occupancy Ψ (CI)` = psi, `Ψ (CI)` = alt_psi, `γ (CI)` = alt_col, `ε (CI)` = alt_ext, `c-hat` = c_hat, `p-value` = p_value_Chisq, `wAICc` = AICcWt) 

# call gt and produce pretty table
sum_table_gt_1 <- gt(sum_table_1) %>% tab_header(
    title = md("The Effect of Elevation on Initial Occupancy Ψ, Colonization γ and Extinction ε Probabilities")) %>%
  #tab_spanner(
  #  label = "GoF",
  #  columns = c("p-value")) %>% # add c-hat value here if needed
  tab_spanner(
    label = "Effect of Elevation on",
    columns = c("Ψ (CI)","γ (CI)","ε (CI)")) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")),
    locations = list(cells_column_labels(
      columns = everything()), cells_title())) %>%
  cols_align(
    align = "right",
    columns = c("Formula (~Ψ~γ~ε~P)")) %>%
  cols_align(
    align = "left", 
    columns = c("Model", "Species")) %>%
  cols_align(
    align = "center",
    columns = c("Initial Occupancy Ψ (CI)",                          
                "Ψ (CI)",
                # "c-hat", 
                "γ (CI)",
                "ε (CI)")) %>% 
  cols_width("Ψ (CI)" ~ px(200),
             "γ (CI)" ~ px(200), 
             "ε (CI)" ~ px(200), 
            # "c-hat" ~ px(100), 
             "wAICc" ~ px(100), 
             "Initial Occupancy Ψ (CI)" ~ px(200)) %>% 
  tab_footnote(
    footnote = "For MTOR and SBTH the effect sizes of elevation:treeheight are displayed.",
    locations = cells_body(
      columns = c(5),
      rows = c(7,10))) %>% 
  tab_source_note(
    source_note = md("**Model Parameters**: Ψ = Initial Occupancy; γ = Colonization Probability;  ε = Extinction Probability; P = Detection Probability; CI = Confidence Interval Limits (lower, upper).<br>
    **Model Predictors**: day = survey day; time = survey time; rain = 1 - 'rain' and 0 - 'no rain' during survey; wind = wind strength ('calm' - 1, 'light' - 2, 'moderate' - 3, 'high' - 4) during survey; activity = general bird activity; elevation = elevation in m a.s.l.; location = 'flat-open', 'valley', 'midslope', or 'ridge'; dbh = diameter-breast height (DBH); treeheight = tree-height around the survey point; canopy = canopy cover around survey point; year_num = survey year as numeric value, year_fact = survey year as factor value.<br>
    **Weight of Evidence**: wAICc = corrected Akaike weights.<br>
    **Species**: ACHU = Antillean Crested Hummingbird; BANA = Bananaquit; BRQD = Bridled Quail-Dove; 
    CAEL = Caribbean Elaenia; FOTH = Forest Thrush; GTCA = Green-Throated Carib; MTOR = Montserrat Oriole; 
    PETH = Pearly-Eyed Thrasher; PTCA = Purple-Throated Carib; SBTH = Scaly-Breasted Thrasher; SNPI = Scaly-Naped Pigeon; 
    TREM = Brown Trembler.")) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c('top'), color = 'black', weight = px(2.25))),
    locations = list(cells_title())) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c('bottom'), color = 'black', weight = px(1.5))),
    locations = list(cells_title())) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c("bottom"), color = 'black', weight = px(2.25))),
    locations = list(cells_column_labels(), cells_body(rows = 12)))
sum_table_gt_1 

# write_excel_csv2(x = sum_table_1, file = 'C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/plots/summary_table_1.csv')
gtsave(sum_table_gt_1, filename = 'C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/plots/summary_table_1.docx')
gtsave(sum_table_gt_1, filename = 'C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/plots/summary_table_1.html')



sum_table_2 <- sum_table %>% mutate(across(everything(), ~ str_replace(., "^NA.*", "")), formula = str_replace_all(formula, ' ', ''), c_hat = ifelse(c_hat == '0', '<0.001', c_hat)) %>% # replace all NA's and delete spaces in formula
  separate(formula, sep = '(?=~)', into = c('trash', 'Ψ', 'γ', 'ε', 'P')) %>% 
  rename(Species = species, Model = model, `Initial Occupancy Ψ (CI)` = psi, `Ψ (CI)` = alt_psi, `γ (CI)` = alt_col, `ε (CI)` = alt_ext, `c-hat` = c_hat, `p-value` = p_value_Chisq, `wAICc` = AICcWt) %>% 
  select(Species, Model, `Ψ`, `γ`, `ε`, `P`, `Ψ (CI)`, `γ (CI)`, `ε (CI)`, wAICc, -`c-hat`, -`p-value`, -`Initial Occupancy Ψ (CI)`) # display columns in the correct order

# call gt and produce pretty table
sum_table_gt_2 <- gt(sum_table_2) %>% tab_header(
    title = md("The Effect of Elevation on Initial Occupancy Ψ, Colonization γ and Extinction ε Probabilities")) %>%
  tab_spanner(
   label = "Formula of Model Components",
   columns = c("Ψ", "γ", "ε", "P")) %>% 
  tab_spanner(
    label = "Effect of Elevation on",
    columns = c("Ψ (CI)","γ (CI)","ε (CI)")) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")),
    locations = list(cells_column_labels(
      columns = everything()), cells_title())) %>%
  cols_align(
    align = "left",
    columns = c("Ψ","γ","ε", "P")) %>%
  cols_align(
    align = "left", 
    columns = c("Model", "Species")) %>%
  cols_align(
    align = "center",
    columns = c(# "Initial Occupancy Ψ (CI)",                          
                "Ψ (CI)",
                # "c-hat", 
                "γ (CI)",
                "ε (CI)")) %>% 
  cols_width("Ψ (CI)" ~ px(200),
             "γ (CI)" ~ px(200), 
             "ε (CI)" ~ px(200), 
            # "c-hat" ~ px(100), 
             "wAICc" ~ px(100)) %>% 
  tab_footnote(
    footnote = "For MTOR and SBTH the effect sizes of elevation:treeheight are displayed.",
    locations = cells_body(
      columns = 7,
      rows = c(7,10))) %>% 
  tab_source_note(
    source_note = md("**Model Parameters**: Ψ = Initial Occupancy; γ = Colonisation Probability;  ε = Extinction Probability; P = Detection Probability; CI = Confidence Interval Limits (lower, upper).<br>
    **Model Predictors**: day = survey day; time = survey time; rain = 1 - 'rain' and 0 - 'no rain' during survey; wind = wind strength ('calm' - 1, 'light' - 2, 'moderate' - 3, 'high' - 4) during survey; activity = general bird activity; elevation = elevation in m a.s.l.; location = 'flat-open', 'valley', 'midslope', or 'ridge'; dbh = diameter-breast height (DBH); treeheight = tree-height around the survey point; canopy = canopy cover around survey point; year_num = survey year as numeric value, year_fact = survey year as factor value.<br>
    **Weight of Evidence**: wAICc = weights of Evidence.<br>
    **Species**: ACHU = Antillean Crested Hummingbird; BANA = Bananaquit; BRQD = Bridled Quail-Dove; 
    CAEL = Caribbean Elaenia; FOTH = Forest Thrush; GTCA = Green-Throated Carib; MTOR = Montserrat Oriole; 
    PETH = Pearly-Eyed Thrasher; PTCA = Purple-Throated Carib; SBTH = Scaly-Breasted Thrasher; SNPI = Scaly-Naped Pigeon; 
    TREM = Brown Trembler.")) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c('top'), color = 'black', weight = px(2.25))),
    locations = list(cells_title())) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c('bottom'), color = 'black', weight = px(1.5))),
    locations = list(cells_title())) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c("bottom"), color = 'black', weight = px(2.25))),
    locations = list(cells_column_labels(), cells_body(rows = 12)))
sum_table_gt_2 

# write_excel_csv2(x = sum_table_2, file = 'C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/plots/summary_table_2.csv')
gtsave(sum_table_gt_2, filename = 'C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/plots/summary_table_2.docx')
gtsave(sum_table_gt_2, filename = 'C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/plots/summary_table_2.html')
```

### Dynamics of colonisation and extinction along elevation \[old\]

For the Montserrat Oriole colonisation increased with elevation from `r min(pred_colext %>% filter(species == 'MTOR') %>% filter(Type == 'Colonisation') %>% pull(Predicted))` to `r max(pred_colext %>% filter(species == 'MTOR') %>% filter(Type == 'Colonisation') %>% pull(Predicted))` and extinction decreased with elevation from `r max(pred_colext %>% filter(species == 'MTOR') %>% filter(Type == 'Extinction') %>% pull(Predicted))` to `r min(pred_colext %>% filter(species == 'MTOR') %>% filter(Type == 'Extinction') %>% pull(Predicted))` (Table 3, Figure 2). Notably, the steepness of both colonisation and extinction slopes was highest at low elevations but flattening towards higher elevations, while at high elevations colonisation approached 1 and extinction approached 0. The ‘expansion’ model for the Purple-Throated Carib suggested that colonisation increased with elevation from `r min(pred_colext %>% filter(species == 'PTCA') %>% filter(Type == 'Colonisation') %>% pull(Predicted))` and `r max(pred_colext %>% filter(species == 'PTCA') %>% filter(Type == 'Colonisation') %>% pull(Predicted))` (Table 3). The models for the Brown Trembler and Bridled Quail-Dove indicated decreasing extinction along elevation ranging from `r max(pred_colext %>% filter(species == 'TREM') %>% filter(Type == 'Extinction') %>% pull(Predicted))` to `r min(pred_colext %>% filter(species == 'TREM') %>% filter(Type == 'Extinction') %>% pull(Predicted))` and `r max(pred_colext %>% filter(species == 'BRQD') %>% filter(Type == 'Extinction') %>% pull(Predicted))` to `r min(pred_colext %>% filter(species == 'BRQD') %>% filter(Type == 'Extinction') %>% pull(Predicted))`, respectively. Again, extinction flattened considerably towards higher elevations. Contrastingly, for the Scaly-Breasted Thrasher extinction generally increased with elevation spanning from `r min(pred_colext %>% filter(species == 'SBTH') %>% filter(Type == 'Extinction') %>% pull(Predicted))` to `r max(pred_colext %>% filter(species == 'SBTH') %>% filter(Type == 'Extinction') %>% pull(Predicted))`.

```{r, include=FALSE}
#| label: just to be quicker with replacing any values in the text
# min/max col/ext per species 
#min(pred_colext %>% filter(species == 'TREM') %>% filter(Type == 'Extinction') %>% pull(Predicted))
#max(pred_colext %>% filter(species == 'TREM') %>% filter(Type == 'Extinction') %>% pull(Predicted))

# effect sizes and CIs
#coeff_bm %>% filter(species=='MTOR') %>% filter(component =='ext(alt)') %>% pull(estimate)
#coeff_bm %>% filter(species=='TREM') %>% filter(component =='ext(alt)') %>% pull(lower)
#coeff_bm %>% filter(species=='TREM') %>% filter(component =='ext(alt)') %>% pull(upper)

```

```{r, warning=F}
#| label: Colext plot
# plot for colext dynamics 
plot_colext <- pred_colext %>% 
  ggplot() +
  geom_line(mapping = aes(x = Elevation, y = Predicted, col = Type)) + 
  geom_ribbon(mapping = aes(ymin = lower,ymax = upper, x = Elevation, fill = Type), alpha = 0.3) + 
  facet_wrap(~species_names) + 
  
  labs(x="Elevation (in m a.s.l.)", y="Predicted probability", col = 'Legend', fill = 'Legend') + 
  scale_fill_viridis_d(alpha=0.3,begin=0,end=0.97,direction=1) + # set begin/end to 0.98 for yellow/ext // 0 for purple/col
  scale_color_viridis_d(alpha=1,begin=0,end=0.97,direction=1) +
  scale_y_continuous(limits = c(0, 1)) +
  
  theme_bw() + 
  theme(
    legend.position = c(0.835, 0.25), # Adjust for desired position
    # legend.position.inside = element_rect(fill = "white", color = "black", size = 0.5),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 10), 
    strip.text = element_text(size = 10))
print(plot_colext)
ggsave(filename = 'colext_figure.png', plot = plot_colext, path = 'C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/plots', width = 8, height = 6)
```

## Supplementary

### Supplementary 1: Table of variables used as predictors

```{r}
#| label: table for variables 
variables <- read.csv2(file = 'C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/Variables_table.csv')

variables_gt <- gt(variables) %>% tab_header(
    title = md("Definitions of Variables used as Predictors")) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")),
    locations = list(cells_column_labels(
      columns = everything()), cells_title())) %>%
  cols_align(
    align = "left", 
    columns = c("Type", "Covariate", "Metric", "Definition")) %>%
  tab_source_note(
    source_note = md("**Type**: obsCov = Observation Level Covariates, siteCov = Site Level Covariates,  yearlySiteCov = Year Level Covariates.<br>
                     **Transformation**: All numeric variables were scaled to a mean of 0 and standard deviation of 1.")) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c('top'), color = 'black', weight = px(2.25))),
    locations = list(cells_title())) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c('bottom'), color = 'black', weight = px(1.5))),
    locations = list(cells_title())) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c("bottom"), color = 'black', weight = px(2.25))),
    locations = list(cells_column_labels(), cells_body(rows = 12)))
variables_gt

gtsave(variables_gt, filename = 'C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/plots/variables.docx')
gtsave(variables_gt, filename = 'C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/plots/variables.html')
```

### Appendix 2: Model selection table for all species and only the final step models

```{r}
#| label: Model Comparison Table for Final Candidate Models for Each Species 

modsel_table_last_step <- modsel %>% filter(step == 'g_e') %>%
  mutate(step = recode(step, 'g_e' = 'ε,γ', 'psi' = 'Ψ', 'p' = 'P'), AICc = round(AICc, digits = 2), Delta_AICc = round(Delta_AICc, 2), AICcWt = format(round(AICcWt, 2), scientific = F)) %>% 
  select(-species_names, -LL, -ModelLik, -p_value_SSE, -p_value_freemanTukey, -Cum.Wt, -c_hat, -p_value_Chisq, -step) %>% 
  rename(Species = species, `Formula (~Ψ~γ~ε~P)` = formula, nPars = K, ΔAICc = Delta_AICc, `AIC weight` = AICcWt, Model = model) %>% 
  select(Species, Model, everything())

modsel_table_last_step_gt <- modsel_table_last_step %>%
  gt() %>%
  tab_header(
    title = md("Model Comparison Table for Final Candidate Models for Each Species")) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")),
    locations = list(cells_column_labels(
      columns = everything()), cells_title())) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")),
    locations = list(cells_body(rows = c(1,14,27,40, 53, 66, 79, 92, 105, 118, 131, 144)))) %>%
  cols_align(
    align = "right",
    columns = c("Formula (~Ψ~γ~ε~P)", "AICc", "ΔAICc", "nPars")) %>%
  cols_align(
    align = "left", 
    columns = c("Species")) %>% 
  tab_source_note( # add notes below the table coded as markdown by md()
    source_note = md("**Model Parameters**: Ψ = Initial Occupancy; γ = Colonisation Probability;  ε = Extinction Probability; P = Detection Probability.<br>
    **Model Predictors**: day = survey day; time = survey time; rain = 1 - 'rain' and 0 - 'no rain' during survey; wind = wind strength ('calm' - 1, 'light' - 2, 'moderate' - 3, 'high' - 4) during survey; activity = general bird activity; elevation = elevation in m a.s.l.; location = 'flat-open', 'valley', 'midslope', or 'ridge'; dbh = diameter-breast height (DBH); treeheight = tree-height around the survey point; canopy = canopy cover around survey point; year_num = survey year as numeric value, year_fact = survey year as factor value.<br>
    **Model Comparison Parameter**: nPars = Number of Parameters; AICc = corrected Aikake Information Criterion; ΔAICc = Delta AICc; wAICc = weights of Evidence.<br>
    **Species**: ACHU = Antillean Crested Hummingbird; BANA = Bananaquit; BRQD = Bridled Quail-Dove; 
    CAEL = Caribbean Elaenia; FOTH = Forest Thrush; GTCA = Green-Throated Carib; MTOR = Montserrat Oriole; 
    PETH = Pearly-Eyed Thrasher; PTCA = Purple-Throated Carib; SBTH = Scaly-Breasted Thrasher; SNPI = Scaly-Naped Pigeon; 
    TREM = Brown Trembler.")) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c('top'), color = 'black', weight = px(2.25))),
    locations = list(cells_title())) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c('bottom'), color = 'black', weight = px(1.5))),
    locations = list(cells_title())) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c("top"), color = 'gray', weight = px(1))),
    locations = list(cells_column_labels(), cells_body(rows = c(1,14,27,40, 53, 66, 79, 92, 105, 118, 131, 144)))) %>%
  tab_style(
    style = list(
      cell_borders(sides = c("bottom"), color = 'black', weight = px(2.25))),
    locations = list(cells_body(rows = 156))) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c('bottom'), color = 'black', weight = px(1.5))),
    locations = list(cells_column_labels()))
modsel_table_last_step_gt

# write_excel_csv2(x = modsel_table_last_step, file = 'C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/plots/modsel_table_last_step.csv')
#gtsave(modsel_table_last_step_gt, filename = 'C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/plots/modsel_table_last_step.docx')
#gtsave(modsel_table_last_step_gt, filename = 'C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/plots/modsel_table_last_step.html')

```

### Appendix 3.1: Model Comparison Tables for All Species and All Steps - Version sort by modelling step

```{r}
#| label: Model Comparison Tables for All Species and All Steps - including modelling step

modsel_table_full <- modsel %>% 
  mutate(step = recode(step, 'g_e' = 'ε,γ', 'psi' = 'Ψ', 'p' = 'P'), Delta_AICc = round(Delta_AICc, 2), AICcWt = format(round(AICcWt, 2), scientific = F)) %>% 
  select(-species_names, -LL, -ModelLik, -p_value_SSE, -p_value_freemanTukey, -Cum.Wt,-model, -c_hat, -p_value_Chisq) %>% 
  rename(Species = species, Step = step, `Formula (~Ψ~γ~ε~P)` = formula, nPars = K, ΔAICc = Delta_AICc, wAICc = AICcWt) %>% 
  select(Species, Step, everything())

modsel_table_full_gt <- modsel_table_full %>%
  gt() %>%
  tab_header(
    title = md("Model Comparison Tables for All Species and All Steps")) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")),
    locations = list(cells_column_labels(
      columns = everything()), cells_title())) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")),
    locations = list(cells_body(rows = seq(from = 1, to = length(SPECIES)*41, by = 41)))) %>%
  cols_align(
    align = "right",
    columns = c("Formula (~Ψ~γ~ε~P)", "AICc", "ΔAICc", "nPars")) %>%
  cols_align(
    align = "left", 
    columns = c("Species")) %>% 
  cols_width(
    'Formula (~Ψ~γ~ε~P)' ~ px(595)) %>%
  tab_source_note( # add notes below the table coded as markdown by md()
    source_note = md("**Models**: Refers to the candidate models in the last modelling step (ε, γ) (more detailed explaination in the methods section).<br>
    **Model Parameters**: Ψ = Initial Occupancy; γ = Colonisation Probability;  ε = Extinction Probability; P = Detection Probability.<br>
    **Model Predictors**: day = survey day; time = survey time; rain = 1 - 'rain' and 0 - 'no rain' during survey; wind = wind strength ('calm' - 1, 'light' - 2, 'moderate' - 3, 'high' - 4) during survey; activity = general bird activity; elevation = elevation in m a.s.l.; location = 'flat-open', 'valley', 'midslope', or 'ridge'; dbh = diameter-breast height (DBH); treeheight = tree-height around the survey point; canopy = canopy cover around survey point; year_num = survey year as numeric value, year_fact = survey year as factor value.<br>
    **Model Comparison Parameter**: nPars = Number of Parameters; AICc = corrected Aikake Information Criterion; ΔAICc = Delta AICc; wAICc = weights of Evidence.<br>
    **Species**: ACHU = Antillean Crested Hummingbird; BANA = Bananaquit; BRQD = Bridled Quail-Dove; 
    CAEL = Caribbean Elaenia; FOTH = Forest Thrush; GTCA = Green-Throated Carib; MTOR = Montserrat Oriole; 
    PETH = Pearly-Eyed Thrasher; PTCA = Purple-Throated Carib; SBTH = Scaly-Breasted Thrasher; SNPI = Scaly-Naped Pigeon; 
    TREM = Brown Trembler.")) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c('top'), color = 'black', weight = px(2.25))),
    locations = list(cells_title())) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c('bottom'), color = 'black', weight = px(1.5))),
    locations = list(cells_title())) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c("top"), color = 'gray', weight = px(1))),
    locations = list(cells_column_labels(), cells_body(rows = seq(from = 1, to = length(SPECIES)*41, by = 41)))) %>%
  tab_style(
    style = list(
      cell_borders(sides = c("bottom"), color = 'black', weight = px(2.25))),
    locations = list(cells_body(rows = 41*length(SPECIES)))) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c('bottom'), color = 'black', weight = px(1.5))),
    locations = list(cells_column_labels()))
modsel_table_full_gt

gtsave(modsel_table_full_gt, filename = 'C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/plots/modsel_table_full.docx')
gtsave(modsel_table_full_gt, filename = 'C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/plots/modsel_table_full.html')
```

### 

### Appendix 3.2: Model Comparison Tables for All Species and All Steps - Version pooled over modelling steps

```{r}
#| label: Model Comparison Tables for All Species and All Steps pooled over modelling steps 


modsel_table_full_2 <- modsel %>% select(-step, -model, -ModelLik, -AICcWt, -LL, -Cum.Wt, -c_hat, -p_value_SSE, -p_value_Chisq, -p_value_freemanTukey, -species_names, -Delta_AICc) %>% group_by(species, formula) %>% distinct() %>% 
  group_by(species) %>% 
  mutate(Delta_AICc = AICc-min(AICc), # recalculate DeltaAICc for all models 
    wAICc = exp(-0.5*Delta_AICc)/sum(exp(-0.5*Delta_AICc))) %>% # recaluclate wAICc
  mutate(Delta_AICc = round(Delta_AICc, 2), wAICc = format(round(wAICc, 2), scientific = F)) %>% 
  rename(Species = species, `Formula (~Ψ~γ~ε~P)` = formula, nPars = K, ΔAICc = Delta_AICc) %>% 
  select(Species, everything()) %>% ungroup() # ungroup to avoid issues with gt


modsel_table_full_gt_2 <- modsel_table_full_2 %>%
  gt() %>%
  tab_header(
    title = md("Model Comparison Table for All Species")) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")),
    locations = list(cells_column_labels(
      columns = everything()), cells_title())) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")),
    locations = list(cells_body(rows = seq(from = 1, to = length(SPECIES)*41, by = 41)))) %>%
  cols_align(
    align = "right",
    columns = c("Formula (~Ψ~γ~ε~P)", "AICc", "ΔAICc", "nPars")) %>%
  cols_align(
    align = "left", 
    columns = c("Species")) %>% 
  cols_width(
    'Formula (~Ψ~γ~ε~P)' ~ px(595)) %>%
  tab_source_note( # add notes below the table coded as markdown by md()
    source_note = md("**Models**: Refers to the candidate models in the last modelling step (ε, γ) (more detailed explaination in the methods section).<br>
    **Model Parameters**: Ψ = Initial Occupancy; γ = Colonisation Probability;  ε = Extinction Probability; P = Detection Probability.<br>
    **Model Predictors**: day = survey day; time = survey time; rain = 1 - 'rain' and 0 - 'no rain' during survey; wind = wind strength ('calm' - 1, 'light' - 2, 'moderate' - 3, 'high' - 4) during survey; activity = general bird activity; elevation = elevation in m a.s.l.; location = 'flat-open', 'valley', 'midslope', or 'ridge'; dbh = diameter-breast height (DBH); treeheight = tree-height around the survey point; canopy = canopy cover around survey point; year_num = survey year as numeric value, year_fact = survey year as factor value.<br>
    **Model Comparison Parameter**: nPars = Number of Parameters; AICc = corrected Aikake Information Criterion; ΔAICc = Delta AICc; wAICc = weights of Evidence.<br>
    **Species**: ACHU = Antillean Crested Hummingbird; BANA = Bananaquit; BRQD = Bridled Quail-Dove; 
    CAEL = Caribbean Elaenia; FOTH = Forest Thrush; GTCA = Green-Throated Carib; MTOR = Montserrat Oriole; 
    PETH = Pearly-Eyed Thrasher; PTCA = Purple-Throated Carib; SBTH = Scaly-Breasted Thrasher; SNPI = Scaly-Naped Pigeon; 
    TREM = Brown Trembler.")) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c('top'), color = 'black', weight = px(2.25))),
    locations = list(cells_title())) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c('bottom'), color = 'black', weight = px(1.5))),
    locations = list(cells_title())) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c("top"), color = 'gray', weight = px(1))),
    locations = list(cells_column_labels(), cells_body(rows = c(1,39, seq(78, 39+((length(SPECIES)-1)*38), by = 38))))) %>%
  tab_style(
    style = list(
      cell_borders(sides = c("bottom"), color = 'black', weight = px(2.25))),
    locations = list(cells_body(rows = nrow(modsel_table_full_2)))) %>% 
  tab_style(
    style = list(
      cell_borders(sides = c('bottom'), color = 'black', weight = px(1.5))),
    locations = list(cells_column_labels()))
modsel_table_full_gt_2

gtsave(modsel_table_full_gt_2, filename = 'C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/plots/modsel_table_full_pooled_steps.docx')
gtsave(modsel_table_full_gt, filename = 'C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/plots/modsel_table_full_pooled_steps.html')




```

### 

### Appendix 4: Occupancy trajectories

```{r, warning=F}
#| label: occupancy trajectories 

plot_occu <- occu %>% 
  ggplot() +
  geom_point(mapping = aes(x = Year, y = Occupancy), col = 'firebrick', size = 1.7, position = position_dodge(width = 0)) +
  geom_errorbar(mapping = aes(ymin = lower_cl, ymax = upper_cl, x = Year), 
                width = 0.4, size = 0.5, position = position_dodge(width = 0)) +
  facet_wrap(~species_names, nrow = 4) +
  
  scale_y_continuous(limits = c(0, 1.1), breaks=seq(0,1,0.2),labels=seq(0,1,0.2))  +
  scale_x_continuous(limits = c(2010, 2025), breaks=seq(2011,2025,4),labels=seq(2011,2025,4)) +

  theme_test() +
  theme(strip.text = element_text(size = 10))
print(plot_occu)
ggsave(filename = 'occu_figure.png', plot = plot_occu, path = 'C:/Users/filib/Documents/Praktika/Sempach/Montserrat/Range_Changes_Montserrat/output/plots', width = 7, height = 9)
```
